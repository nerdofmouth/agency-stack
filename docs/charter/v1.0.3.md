# ðŸ§  AgencyStack Charter v1.0.3 (Operational Discipline)

## 1. Purpose & Mission
AgencyStack (Upstack.agency) is a sovereign, auditable, and repeatable infrastructure platform for small agencies, creators, and co-ops. It enables secure, multi-tenant, AI-enhanced, and customizable deploymentsâ€”spanning foundational infrastructure, business productivity, communication, and AI-driven SaaSâ€”using only repository-tracked, idempotent, and documented workflows.

## 2. Core Principles
- **Repository as Source of Truth:** All installation, configuration, and operational logic must be defined and tracked in the repository. Never modify live VMs directly.
- **Idempotency & Automation:** All scripts, Makefile targets, and Docker builds must be rerunnable without harmful side effects.
- **Auditability & Documentation:** Every component, script, and workflow must be documented in human-readable markdown in `/docs/pages/components/` and referenced in this Charter. Logs are stored under `/var/log/agency_stack/components/`.
- **Sovereignty:** No dependency on external services unless explicitly enabled. All critical infrastructure is self-hosted and reproducible.
- **Multi-Tenancy & Security:** Default to tenant isolation, strong authentication (Keycloak SSO), and strict resource boundaries. TLS is required for all networked services.
- **Strategic Alignment:** All work must map to the current AgencyStack roadmap and phase objectives, from infrastructure to AI-driven SaaS and public launch.
- **Proper Change Workflow:** All changes must be made in the local repo, tested, committed, and deployed only via tracked scripts or Makefile targets. No manual or post-hoc fixes.
- **Component Consistency:** Every installable component must have: a tracked install script, Makefile targets, docs, registry entry, and logs.
- **Debugging Discipline:** Extract configs from VMs, fix in repo, document, and redeploy. Never patch VMs directly.
- **WSL2/Docker Mount Safety:** All Docker volume mounts must be rigorously validated to ensure file vs. directory type consistency. Never assume Docker will correctly handle a file vs. directory mismatch.
- **Automated Remote Operations:** Use non-interactive SSH commands from host to execute scripted operations inside containers and VMs, maintaining repository integrity while enabling operational efficiency.

## 3. Directory & File Structure
| Purpose | Path |
|--------|------|
| Install scripts | `/scripts/components/` |
| Utility scripts | `/scripts/utils/` |
| Mock/test code | `/scripts/mock/` |
| Component docs | `/docs/pages/components/` |
| Logs | `/var/log/agency_stack/components/<component>.log` |
| Install output | `/opt/agency_stack/clients/${CLIENT_ID}/<component>/` |

Never write to `/usr`, `$HOME`, or system paths unless explicitly instructed.

## 4. Installation & Change Workflow
1. Make changes ONLY to the local repository.
2. Test locally where possible.
3. Commit changes with descriptive messages.
4. Transfer changes to remote VMs ONLY through:
   - Git pull from authorized repositories
   - Official installation scripts
   - Makefile targets
   - **Automated SSH commands from host to containers/VMs**
5. Document all behavior and changes in the repo.
6. When debugging, extract configs from VMs, fix in the repo, document, and redeploy.
7. All fixes must be incorporated into the codebase for future deployments.
8. For Docker/WSL environments, all file validations must explicitly check for and handle file vs. directory conflicts.

## 5. Dev Container Build & Customization Policy
- All dev containers are built from `Dockerfile.dev`, orchestrated by `scripts/utils/create_base_docker_dev.sh`.
- Custom themes, shells, and tools are version-controlled and installed during build (never post-hoc inside running containers).
- Default shell and prompt branding (e.g., AgencyStack Oh My Zsh theme) are set in the Dockerfile.
- Any customization must be documented and referenced in this Charter.

**Instruction:**
> When updating the dev container environment, always:
> - Add new tools, shells, or themes to `Dockerfile.dev`.
> - Place custom themes or configs (e.g., `custom-themes/agency-jonathan.zsh-theme`) in the repository.
> - Use `scripts/utils/create_base_docker_dev.sh` to build and run the container.
> - Never make changes directly inside a running container that are not reflected in the repo.

## 6. Remote Operation Imperatives (NEW)

When operating on remote systems (containers, VMs, or cloud instances):

1. **Command Automation:**
   - Use non-interactive SSH commands from the host to execute operations
   - Script and parameterize all operations that require multiple steps
   - Store sensitive parameters in proper secrets management (not hardcoded)

2. **Execution Workflow:**
   - Use `ssh [user]@[host] -p [port] 'cd /path && command'` pattern for remote execution
   - For containers: `docker exec [container_name] bash -c 'cd /path && command'`
   - Always specify working directory explicitly with `cd` before command execution
   - Set timeout and retry logic for unstable connections

3. **Output Handling:**
   - Capture command output for auditing and troubleshooting
   - Parse key results to verify success/failure
   - Log operations to both local and remote logs

4. **Repository Alignment:**
   - Remote commands should execute scripts from repository, not ad-hoc commands
   - Pull repository changes before executing commands when needed
   - Use repository-defined configurations and parameters

5. **Docker-in-Docker Operations:**
   - When Docker operations are needed inside containers, use socket mounting
   - Document Docker socket security implications
   - Validate Docker command execution permission before operations

## 7. Makefile & Component Registry Standards
- Every component must have Makefile targets: `make <component>`, `make <component>-status`, `make <component>-logs`, `make <component>-restart`, `make <component>-test` (optional).
- All installable components must be tracked in `component_registry.json` with accurate flags and metadata (including SSO, monitoring, multi_tenant, etc).
- SSO-enabled components must integrate with Keycloak and document their configuration. Add `sso_configured: true` only after live integration is tested.
- All networked ports must be documented in `/docs/pages/ports.md` and reflected in the registry.

## 8. Documentation & Auditability
- All new features, fixes, and customizations must be documented in `/docs/pages/components/` and referenced in this Charter.
- Use `/scripts/utils/` helpers for logging, validation, and registry updates.
- Component documentation must include: Purpose, Paths, Logs, Ports, Restart methods, Security details.
- Mock/test scripts (`/scripts/mock/`) are required for UI/LLM components.

## 9. Docker Development Workflow

1. **Host-to-Container Directionality**
   - The host repository is the authoritative source of truth 
   - Changes flow one-way from host to container, never container to host
   - Container filesystem changes are considered disposable and experimental
   - Permanent changes must be made on the host repository first

2. **Repository Mounting Strategy**
   - Use named volumes for repository persistence (`agencystack-dev_repo`)
   - Implement explicit sync mechanism via `scripts/utils/sync_to_container.sh`
   - Never bind-mount the repository directory directly to preserve filesystem boundaries
   - All syncs are initiated from the host, maintaining the one-way flow principle

3. **Docker-in-Docker Compatibility**
   - All installation scripts must detect container environments via `is_running_in_container()`
   - Use container-safe log directories (e.g., `$HOME/.logs/` inside containers) 
   - Installation scripts must use container-friendly network detection
   - Avoid absolute paths that assume host filesystem structure
   - Component scripts must be idempotent and safely re-runnable in containers

4. **Testing Protocol**
   - Test all installation commands from within the container environment
   - Verify proper network connectivity between containers
   - Ensure configuration is properly generated in container paths
   - Use `make <component>-test` to validate container installations
   - Document container-specific configuration in component docs

## 10. Security, SSO, & Testing
- All networked services require TLS. Self-signed certificates are permitted only in dev environments.
- Keycloak is the system-wide identity provider for SSO-enabled components. No alternative auth systems are permitted.
- All component endpoints must have security tests (authentication, authorization, input validation).
- Secrets must be stored in `/opt/agency_stack/clients/${CLIENT_ID}/.secrets/` (not in the repo) with appropriate permissions.
- All component tests must pass with `make <component>-test` before production deployment.

## 11. Docker & WSL Environment Rules
- Container orchestration is via `docker-compose.yml` files stored in the repository.
- Volume mounts must specify with absolute paths (e.g., `/opt/agency_stack/clients/${CLIENT_ID}/traefik/traefik.yml:/etc/traefik/traefik.yml:ro`).
- All Docker volumes are created with specific naming conventions: `${COMPONENT_NAME}_${CLIENT_ID}_${PURPOSE}`.
- WSL2 environments must validate file vs. directory conflicts explicitly before Docker operations.
- Installation scripts must handle platform detection and WSL2-specific configurations.
- No host-level changes should be made that aren't tracked in the repository or documented in this Charter.

## ðŸ§  MINDSET FOR AGENCY STACK DEVELOPMENT

### Core Development Principles

1. **Container Isolation** - Development, testing, and all code execution MUST happen inside the container environment
   - Never execute installation scripts directly on the host system
   - All commands must be run through `docker exec -it --user developer agencystack-dev zsh` or equivalent
   - Preserve host system integrity by maintaining container boundaries

2. **Repository Integrity** - The repository is the single source of truth
   - All changes must be committed to the repository before deployment
   - Configuration should be repeatable across environments
   - Installation scripts must handle docker-in-docker scenarios gracefully

3. **Filesystem Respect** - Never write outside designated paths
   - Use proper logging paths with fallbacks for permission issues
   - Honor containerization boundaries for file operations
   - Create idempotent scripts that clean up after themselves

4. **Testing Discipline** - Every component must be testable in isolation
   - Components should detect their environment and adapt accordingly
   - Scripts must handle permission differences between host and container
   - Network detection and adaptation must work in both direct and nested scenarios

### Repository Mounting Strategy

1. **Host-to-Container Directionality**
   - The host repository is the authoritative source of truth 
   - Changes flow one-way from host to container, never container to host
   - Container filesystem changes are considered disposable and experimental
   - Permanent changes must be made on the host repository first

2. **Filesystem Boundaries**
   - **Host Filesystem**: Source code, configuration files, and documentation
     - Changes here are permanent and should be committed to git
     - Never modify host filesystem from within containers
   - **Container Filesystem**: Runtime artifacts, logs, and temporary data
     - Generated during component installation and testing
     - Disposable and recreatable from source code
     - May include development databases, runtime files, and logs

3. **Mounting Mechanisms**
   - Use named volumes for persistence where required
   - Implement deliberate sync mechanisms rather than bi-directional mounts
   - Provide clear indicators of filesystem context in development tools
