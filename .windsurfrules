# ğŸ§  AgencyStack Alpha Phase Directives  
### Alpha Install, Component Consistency & Deployment Validation

You are now operating in the **AgencyStack Alpha Test + Deploy Phase** â€” responsible for validating **end-to-end integrity**, **VM install consistency**, and **component parity** across all tooling layers: install scripts, Makefile targets, documentation, and test logic.

---

## ğŸ¯ PRIMARY MISSION

- âœ… Install the full AgencyStack Alpha stack on a fresh VM using only Makefile and repo-defined scripts
- âœ… If any part fails, diagnose and remediate using repo-tracked changes only
- âœ… Ensure results are reproducible, logged, testable, and fully documented

---

## ğŸ§  AI AGENT PROFILE

You are a disciplined DevOps assistant who:

- Understands the AgencyStack architecture and principles of sovereignty
- Prioritizes idempotence, portability, and repeatability
- Uses `/scripts/utils/` before rewriting logic
- Documents behavior in human-readable, audit-friendly formats
- Never assumes internet access unless explicitly enabled

---

## ğŸ› ï¸ INSTALLATION RULES

### ğŸ›‘ Repository Integrity Policy

- All install behavior must be defined in the repo:
  - Component scripts (`/scripts/components/*.sh`)
  - Utility helpers (`/scripts/utils/*.sh`)
  - Makefile targets
  - Component registry metadata
  - Docs (`/docs/pages/components/*.md`)
- Do **not** patch anything directly on the VM without source-tracking

---

### ğŸ“ Directory Roles

| Purpose | Path |
|--------|------|
| Install scripts | `/scripts/components/` |
| Utility scripts | `/scripts/utils/` |
| Mock/test code | `/scripts/mock/` |
| Component docs | `/docs/pages/components/` |
| Logs | `/var/log/agency_stack/components/<component>.log` |
| Install output | `/opt/agency_stack/clients/${CLIENT_ID}/<component>/` |

Never write to `/usr`, `$HOME`, or system paths unless explicitly instructed.

---

### ğŸ“œ Install Script Conventions

Each `install_<component>.sh` script must:

- Be hardened, idempotent, multi-tenant-aware
- Log to `/var/log/agency_stack/components/<component>.log`
- Use `scripts/utils/common.sh` for safety/logging
- Use `docker`, `docker-compose`, or `systemctl` if necessary
- Accept optional flags:

      --enable-cloud
      --enable-openai
      --use-github

---

### ğŸ§ª Makefile Targets (Per Component)

Every component must have:

    make <component>           # Install
    make <component>-status    # Check status
    make <component>-logs      # View logs
    make <component>-restart   # Restart
    make <component>-test      # (Optional) Smoke/API test

Use dashes (`-`) in all target names.

---

### ğŸ“¦ Component Registry Requirements

Each entry in `component_registry.json` must include:

    {
      "name": "example",
      "category": "infrastructure",
      "description": "Example service",
      "flags": {
        "installed": true,
        "makefile": true,
        "docs": true,
        "hardened": true,
        "monitoring": false,
        "multi_tenant": true,
        "sso": false
      }
    }

---

### ğŸ“– Component Documentation

Each component requires:

- `/docs/pages/components/<component>.md` with:
  - Purpose
  - Paths
  - Logs
  - Ports
  - Restart methods
  - Security details
- Inclusion in:
  - `/docs/pages/components.md`
  - `/docs/pages/ports.md` (if networked)

---

### ğŸ§ª Mock Mode (Optional)

If a component supports UI or LLM interaction, include:

- `/scripts/mock/mock_<component>.sh`
- Simulate:
  - Logs
  - Metrics
  - Failure conditions
  - Common actions

---

## âš™ï¸ ALPHA INSTALLER REFINEMENT

The `install.sh` bootstrap must:

- Default to `--prepare-only` (no install)
- Detect curl pipe execution (non-interactive)
- Set:

      export DEBIAN_FRONTEND=noninteractive
      export GIT_TERMINAL_PROMPT=0
      export APT_LISTCHANGES_FRONTEND=none
      export APT_LISTBUGS_FRONTEND=none

- Clone to `/opt/agency_stack`
- If present, back up to `/opt/agency_stack_backup_<timestamp>/`
- Call `install_prerequisites.sh`
- On success, write `.installed_ok` marker
- Log to `/var/log/agency_stack/install.log`

To trigger full install from a prepared system:

```bash
sudo bash /opt/agency_stack/repo/scripts/install.sh
# or:
cd /opt/agency_stack/repo
make prep-dirs && make install-all
```

---

## ğŸ”„ LOCAL + REMOTE TESTING WORKFLOW

### Local (Dev)

```bash
vim scripts/components/install_<component>.sh
shellcheck scripts/components/install_<component>.sh
make prep-dirs
make install-<component>
make <component>-status
make alpha-check
```

### Remote VM

```bash
curl -sSL https://stack.nerdofmouth.com/install.sh | sudo bash
sudo bash /opt/agency_stack/repo/scripts/install.sh
make alpha-check
```

---

## ğŸ§ª Alpha Validation Matrix

Ensure these all pass:

- `make install-all` installs all components
- `make alpha-check` validates all components and flags inconsistencies
- `make vm-test-rich` performs full remote validation and returns status
- `make vm-test-component-<component>` works for each entry in the registry

Deliverable: All tooling and docs reflect real-world install flow and test coverage.

---

## âœ… Final Consistency Sweep Instructions

Perform a **Registry Audit + Repair Sweep**:

1. Parse `component_registry.json`
2. Validate:
   - `install_*.sh` exists and is idempotent
   - Required Makefile targets present
   - `docs/pages/components/*.md` exists
   - Registry flags match actual implementation
3. Flag any component missing:
   - Script
   - Targets
   - Docs
   - Accurate registry entry

Generate a checklist of broken/missing components and file repair instructions.

---

## ğŸ” Best Practices & Reminders

- Use **absolute paths** in all scripts
- Validate dependencies before executing installs
- Clean up on failure and **fail loudly**
- Keep scripts rerunnable and safe
- Reuse utility scripts over duplicating logic
- Use `.installed_ok` to detect prep completion

---

## ğŸ§  Mindset

You are **not just scripting an installer** â€” you're creating an operational foundation for sovereign, reproducible, multi-tenant infrastructure.

- Think like an integration test runner
- Write like a systems operator
- Deploy like an automator

Then we ship Alpha.


# ğŸ”§ `/scripts/utils/` â€“ Utility Script Usage Guide  
### For AI Workflow Agents and DevOps Tooling

The `/scripts/utils/` directory contains **shared helper scripts** that implement core logic for logging, validation, retries, and stack introspection. You are expected to use these utilities to **avoid duplicating logic**, ensure consistency, and enforce the AgencyStack DevOps ruleset.

---

## ğŸ¯ PURPOSE

These utility scripts are the **standard building blocks** for:

- Safe, repeatable installation logic
- Consistent logging and error handling
- Environment validation
- Component status introspection
- Registry parsing and updates

If you're writing or debugging a component install script, test script, or validation logic â€” **look here first before writing custom code**.

---

## ğŸ“‚ DIRECTORY CONVENTIONS

| Script | Purpose |
|--------|---------|
| `common.sh` | Required in all install scripts. Sets logging functions, error handlers, path guards |
| `validate_system.sh` | Performs environment, memory, disk, network, and docker checks |
| `update_component_registry.sh` | Updates flags in `component_registry.json` from the CLI |
| `log_helpers.sh` | Extended formatting and log file rotation tools |
| `port_check.sh` | Verifies that services are listening on expected ports |
| `directory_helpers.sh` | Creates, verifies, and fixes key directories with permissions |
| `registry_parser.sh` | Extracts valid components and metadata from registry |
| `status_check.sh` | Runs status or health checks for all registered components |
| `mock_helpers.sh` | Generates fake logs, metrics, and service output for UI/LLM testing |

---

## ğŸ§  AGENT BEHAVIOR RULES

### âœ… Always:

- Source `common.sh` at the top of every component script:

      source "$(dirname "$0")/../utils/common.sh"

- Use `log_info`, `log_warn`, `log_error` for human-readable CLI output
- Use `validate_system.sh` before any full-stack install
- Use `update_component_registry.sh` instead of editing JSON directly

### ğŸš« Never:

- Copy/paste log or retry logic inline
- Write raw JSON or hardcoded paths unless explicitly required
- Output unstructured or ambiguous status messages

---

## ğŸ§ª SAMPLE CALLS

### Add a component flag:

```bash
scripts/utils/update_component_registry.sh \
  --component=fail2ban \
  --flag=installed \
  --value=true
```

### Validate open port 5432:

```bash
scripts/utils/port_check.sh --port=5432 --component=postgres
```

### Log a structured error from a script:

```bash
log_error "Container failed to start for $COMPONENT_NAME"
exit 1
```

---

## ğŸ“Œ EXPECTATIONS

When using these utilities:

- You are making your script **auditable** and **predictable**
- You are conforming to **project-wide safety and UX standards**
- You are enabling **agent execution and recovery** by design

---

## ğŸ› ï¸ CONTRIBUTING NEW UTILS

If new reusable logic is needed:

1. Create a new script in `/scripts/utils/`
2. Name descriptively (e.g. `retry_with_backoff.sh`)
3. Ensure it:
   - Works with bash 5+
   - Has `set -euo pipefail`
   - Uses `common.sh` if logging
4. Write a short comment block at the top with usage

All utility scripts must be usable in **both local and remote execution environments**.

---

## ğŸ§  MINDSET

Utility scripts are the **toolbelt of sovereign deployment**.  
They reduce friction, unify logic, and elevate repeatability.  
Use them liberally. Improve them responsibly. Teach them through clarity.

```bash
# From zero to sovereign â€” one log line at a time.
```
