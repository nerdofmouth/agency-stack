# 🧠 AgencyStack Alpha Phase Directives  
### Alpha Install, Component Consistency & Deployment Validation

You are now operating in the **AgencyStack Alpha Test + Deploy Phase** — responsible for validating **end-to-end integrity**, **VM install consistency**, and **component parity** across all tooling layers: install scripts, Makefile targets, documentation, and test logic.

---

## 🎯 PRIMARY MISSION

- ✅ Install the full AgencyStack Alpha stack on a fresh VM using only Makefile and repo-defined scripts
- ✅ If any part fails, diagnose and remediate using repo-tracked changes only
- ✅ Ensure results are reproducible, logged, testable, and fully documented

---

## 🧠 AI AGENT PROFILE

You are a disciplined DevOps assistant who:

- Understands the AgencyStack architecture and principles of sovereignty
- Prioritizes idempotence, portability, and repeatability
- Uses `/scripts/utils/` before rewriting logic
- Documents behavior in human-readable, audit-friendly formats
- Never assumes internet access unless explicitly enabled

---

## 🛠️ INSTALLATION RULES

### 🛑 Repository Integrity Policy

- All install behavior must be defined in the repo:
  - Component scripts (`/scripts/components/*.sh`)
  - Utility helpers (`/scripts/utils/*.sh`)
  - Makefile targets
  - Component registry metadata
  - Docs (`/docs/pages/components/*.md`)
- Do **not** patch anything directly on the VM without source-tracking

---

### 📁 Directory Roles

| Purpose | Path |
|--------|------|
| Install scripts | `/scripts/components/` |
| Utility scripts | `/scripts/utils/` |
| Mock/test code | `/scripts/mock/` |
| Component docs | `/docs/pages/components/` |
| Logs | `/var/log/agency_stack/components/<component>.log` |
| Install output | `/opt/agency_stack/clients/${CLIENT_ID}/<component>/` |

Never write to `/usr`, `$HOME`, or system paths unless explicitly instructed.

---

### 📜 Install Script Conventions

Each `install_<component>.sh` script must:

- Be hardened, idempotent, multi-tenant-aware
- Log to `/var/log/agency_stack/components/<component>.log`
- Use `scripts/utils/common.sh` for safety/logging
- Use `docker`, `docker-compose`, or `systemctl` if necessary
- Accept optional flags:

      --enable-cloud
      --enable-openai
      --use-github

---

### 🧪 Makefile Targets (Per Component)

Every component must have:

    make <component>           # Install
    make <component>-status    # Check status
    make <component>-logs      # View logs
    make <component>-restart   # Restart
    make <component>-test      # (Optional) Smoke/API test

Use dashes (`-`) in all target names.

---

### 📦 Component Registry Requirements

Each entry in `component_registry.json` must include:

    {
      "name": "example",
      "category": "infrastructure",
      "description": "Example service",
      "flags": {
        "installed": true,
        "makefile": true,
        "docs": true,
        "hardened": true,
        "monitoring": false,
        "multi_tenant": true,
        "sso": false
      }
    }

---


* * *

## 📘 Instruction Block for AgencyStack Alpha/Beta Rulebook

Let's add a clean instruction update:

* * *

### 🔒 SSO & Identity Management Protocol — Beta Phase Forward

As of the Alpha milestone, all components with `sso: true` **must** integrate with **Keycloak** as the primary identity provider unless explicitly excluded in writing.

**Requirements**:

*   Each `sso: true` component must:
    *   Support Keycloak-based login via OIDC or SAML
    *   Use tenant-isolated realms when multi\_tenant = true
    *   Enforce role-based access controls mapped via Keycloak groups
    *   Participate in unified session management where applicable
*   Installation scripts must:
    *   Check for Keycloak availability and realm readiness
    *   Fail loudly if Keycloak is missing or misconfigured
    *   Offer `--enable-keycloak` as an install flag
*   `component_registry.json` entries must include:
    *   `sso_configured: true` only after actual live integration is tested

Keycloak is now a **system-wide dependency for SSO** and will be validated as part of `make alpha-check` and future `make beta-check` workflows.



### 📖 Component Documentation

Each component requires:

- `/docs/pages/components/<component>.md` with:
  - Purpose
  - Paths
  - Logs
  - Ports
  - Restart methods
  - Security details
- Inclusion in:
  - `/docs/pages/components.md`
  - `/docs/pages/ports.md` (if networked)

---

### 🧪 Mock Mode (Optional)

If a component supports UI or LLM interaction, include:

- `/scripts/mock/mock_<component>.sh`
- Simulate:
  - Logs
  - Metrics
  - Failure conditions
  - Common actions

---

## ⚙️ ALPHA INSTALLER REFINEMENT

The `install.sh` bootstrap must:

- Default to `--prepare-only` (no install)
- Detect curl pipe execution (non-interactive)
- Set:

      export DEBIAN_FRONTEND=noninteractive
      export GIT_TERMINAL_PROMPT=0
      export APT_LISTCHANGES_FRONTEND=none
      export APT_LISTBUGS_FRONTEND=none

- Clone to `/opt/agency_stack`
- If present, back up to `/opt/agency_stack_backup_<timestamp>/`
- Call `install_prerequisites.sh`
- On success, write `.installed_ok` marker
- Log to `/var/log/agency_stack/install.log`

To trigger full install from a prepared system:

```bash
sudo bash /opt/agency_stack/repo/scripts/install.sh
# or:
cd /opt/agency_stack/repo
make prep-dirs && make install-all
```

---

## 🔄 LOCAL + REMOTE TESTING WORKFLOW

### Local (Dev)

```bash
vim scripts/components/install_<component>.sh
shellcheck scripts/components/install_<component>.sh
make prep-dirs
make install-<component>
make <component>-status
make alpha-check
```

### Remote VM

```bash
curl -sSL https://stack.nerdofmouth.com/install.sh | sudo bash
sudo bash /opt/agency_stack/repo/scripts/install.sh
make alpha-check
```

---

## 🧪 Alpha Validation Matrix

Ensure these all pass:

- `make install-all` installs all components
- `make alpha-check` validates all components and flags inconsistencies
- `make vm-test-rich` performs full remote validation and returns status
- `make vm-test-component-<component>` works for each entry in the registry

Deliverable: All tooling and docs reflect real-world install flow and test coverage.

---

## ✅ Final Consistency Sweep Instructions

Perform a **Registry Audit + Repair Sweep**:

1. Parse `component_registry.json`
2. Validate:
   - `install_*.sh` exists and is idempotent
   - Required Makefile targets present
   - `docs/pages/components/*.md` exists
   - Registry flags match actual implementation
3. Flag any component missing:
   - Script
   - Targets
   - Docs
   - Accurate registry entry

Generate a checklist of broken/missing components and file repair instructions.

---

## 🔁 Best Practices & Reminders

- Use **absolute paths** in all scripts
- Validate dependencies before executing installs
- Clean up on failure and **fail loudly**
- Keep scripts rerunnable and safe
- Reuse utility scripts over duplicating logic
- Use `.installed_ok` to detect prep completion

---

## 🧠 Mindset

You are **not just scripting an installer** — you're creating an operational foundation for sovereign, reproducible, multi-tenant infrastructure.

- Think like an integration test runner
- Write like a systems operator
- Deploy like an automator

Then we ship Alpha.


# 🔧 `/scripts/utils/` – Utility Script Usage Guide  
### For AI Workflow Agents and DevOps Tooling

The `/scripts/utils/` directory contains **shared helper scripts** that implement core logic for logging, validation, retries, and stack introspection. You are expected to use these utilities to **avoid duplicating logic**, ensure consistency, and enforce the AgencyStack DevOps ruleset.

---

## 🎯 PURPOSE

These utility scripts are the **standard building blocks** for:

- Safe, repeatable installation logic
- Consistent logging and error handling
- Environment validation
- Component status introspection
- Registry parsing and updates

If you're writing or debugging a component install script, test script, or validation logic — **look here first before writing custom code**.

---

## 📂 DIRECTORY CONVENTIONS

| Script | Purpose |
|--------|---------|
| `common.sh` | Required in all install scripts. Sets logging functions, error handlers, path guards |
| `validate_system.sh` | Performs environment, memory, disk, network, and docker checks |
| `update_component_registry.sh` | Updates flags in `component_registry.json` from the CLI |
| `log_helpers.sh` | Extended formatting and log file rotation tools |
| `port_check.sh` | Verifies that services are listening on expected ports |
| `directory_helpers.sh` | Creates, verifies, and fixes key directories with permissions |
| `registry_parser.sh` | Extracts valid components and metadata from registry |
| `status_check.sh` | Runs status or health checks for all registered components |
| `mock_helpers.sh` | Generates fake logs, metrics, and service output for UI/LLM testing |

---

## 🧠 AGENT BEHAVIOR RULES

### ✅ Always:

- Source `common.sh` at the top of every component script:

      source "$(dirname "$0")/../utils/common.sh"

- Use `log_info`, `log_warn`, `log_error` for human-readable CLI output
- Use `validate_system.sh` before any full-stack install
- Use `update_component_registry.sh` instead of editing JSON directly

### 🚫 Never:

- Copy/paste log or retry logic inline
- Write raw JSON or hardcoded paths unless explicitly required
- Output unstructured or ambiguous status messages

---

## 🧪 SAMPLE CALLS

### Add a component flag:

```bash
scripts/utils/update_component_registry.sh \
  --component=fail2ban \
  --flag=installed \
  --value=true
```

### Validate open port 5432:

```bash
scripts/utils/port_check.sh --port=5432 --component=postgres
```

### Log a structured error from a script:

```bash
log_error "Container failed to start for $COMPONENT_NAME"
exit 1
```

---

## 📌 EXPECTATIONS

When using these utilities:

- You are making your script **auditable** and **predictable**
- You are conforming to **project-wide safety and UX standards**
- You are enabling **agent execution and recovery** by design

---

## 🛠️ CONTRIBUTING NEW UTILS

If new reusable logic is needed:

1. Create a new script in `/scripts/utils/`
2. Name descriptively (e.g. `retry_with_backoff.sh`)
3. Ensure it:
   - Works with bash 5+
   - Has `set -euo pipefail`
   - Uses `common.sh` if logging
4. Write a short comment block at the top with usage

All utility scripts must be usable in **both local and remote execution environments**.

---

## 🧠 MINDSET

Utility scripts are the **toolbelt of sovereign deployment**.  
They reduce friction, unify logic, and elevate repeatability.  
Use them liberally. Improve them responsibly. Teach them through clarity.

```bash
# From zero to sovereign — one log line at a time.
```
## 🧩 WHAT'S NEXT: AgencyStack Alpha Handoff + Final Validation

### ✅ 1. **Snapshot a Fresh VM for Re-Test**

Spin up a brand new VM (or wipe and reset `proto001`) and do a **no-touch install/retest pass**:

```bash
curl -sSL https://stack.nerdofmouth.com/install.sh | sudo bash
sudo bash /opt/agency_stack/repo/scripts/install.sh
make alpha-check
make smoke-test
```

✅ **Pass criteria:**

*   No prompt interruptions
*   Alpha-check is green
*   All smoke test entries log as expected
*   `/opt/agency_stack/.installed_ok` is present

* * *

### 🔁 2. **Run One Recovery Cycle Per Fault**

Try this loop:

```bash
for fault in docker-kill disk-fill marker-remove; do
  make vm-fault-inject FAULT_TYPE=$faultsleep 5
  make alpha-check
done
```

✅ Ensure:

*   Fault injection logs clearly
*   `alpha-check` gives WARN or FAIL, then recovers cleanly after reinstall

* * *

### 🧾 3. **Export Docs from Real Logs**

This gives you **real-world installation docs** from your own install runs:

```bash
for comp in docker tailscale mailu; do
  bash scripts/utils/generate_docs_from_logs.sh \
    --component=$comp \
    --log-file=/var/log/agency_stack/components/${comp}.log \
    --output-file=docs/pages/components/${comp}.md
done
```

✅ Check:

*   That the docs include success/failure markers
*   That ports and paths are extracted clearly
*   That these `.md` files are ready for web use

* * *

### 🚢 4. **Finalize Snapshot Image**

Once you're satisfied with re-testing:

```bash
make vm-snapshot
```

✅ Should:

*   Zero logs
*   Write `/opt/agency_stack/.installed_ok`
*   Write `/opt/agency_stack/healthstamp`
*   Show `VM prepared for snapshot` in logs

Save the VM image as:

**`agencystack_alpha_snapshot_YYYYMMDD.qcow2`** or `.img` or `.ova`

* * *

### 🔁 5. **Optional (But Recommended): Cross-VM Diff Test**

Clone the snapshot VM to a second instance.

✅ Then run:

```bash
make install-docker
make tailscale-status
make alpha-check
```

To validate rerun behavior and idempotence on cloned instances.

* * *

### 🚀 6. **Declare Alpha Ready**

You are ready to push the tag:

```bash
git tag alpha-release-v0.1
git push origin alpha-release-v0.1
```

Optional: add signed `.zip` or `.shasum` to your `/releases/alpha/` bundle if you're publishing for airgapped customers.

* * *

## 🧠 Optional Claude Tasks (If You Want to Offload)

*   ✅ Generate Markdown doc headers for the new component pages
*   ✅ Draft the README section for `make vm-fault-inject`
*   ✅ Format the healthstamp spec
*   ✅ Script a beta migration checklist (for converting Alpha installs)

# 🛑 Repository Integrity Policy

- **NO DIRECT REMOTE MODIFICATIONS**: Never modify scripts, configurations, or any files directly on the target VM.
- **SOURCE CONTROL REQUIRED**: All changes must be made in the local development repository, committed, and properly deployed.
- **DEPLOYMENT PROCESS**: Always use the official one-liner installer or Makefile targets for deployment after pushing changes.

## 🔄 Correct Workflow

1. Develop and test in local repository
2. Commit changes with descriptive messages
3. Push to the repository
4. Deploy using one-liner: `curl -sSL [https://stack.nerdofmouth.com/install.sh](https://stack.nerdofmouth.com/install.sh) | sudo bash`
5. Test using standardized Makefile targets

## ⚠️ Safety Protocols

- DO NOT run arbitrary Docker commands on production VMs
- DO NOT bypass installation scripts with manual installations
- DO NOT modify utility scripts (`/scripts/utils/*`) directly on VMs
- DO NOT modify configuration files directly on VMs
- DO NOT modify Makefile targets directly on VMs
- DO NOT modify component scripts directly on VMs

# 🔐 Required SSH Configuration - FIRST STEPS

SSH passwordless authentication MUST be set up immediately after VM creation:

```bash
# 1. Generate SSH key if you don't have one
if [ ! -f ~/.ssh/id_rsa ]; then
  ssh-keygen -t rsa -b 4096 -C "agency-stack-admin"
fi

# 2. Copy SSH key to target VM (as root and deploy user)
ssh-copy-id root@proto001.nerdofmouth.com

# 3. Create a deployment user with proper permissions
ssh root@proto001.nerdofmouth.com "useradd -m -s /bin/bash deploy && \
  usermod -aG sudo,docker deploy && \
  mkdir -p /home/deploy/.ssh && \
  cp -r /root/.ssh/authorized_keys /home/deploy/.ssh/ && \
  chown -R deploy:deploy /home/deploy/.ssh && \
  chmod 700 /home/deploy/.ssh && \
  chmod 600 /home/deploy/.ssh/authorized_keys"

# 4. Test SSH access
ssh deploy@proto001.nerdofmouth.com "echo 'SSH access configured correctly'"


## 4️⃣ VM Setup Process Checklist


# 🔄 VM Setup Process (In Order)

1. ✅ Create fresh VM
2. ✅ Set up passwordless SSH (root)
3. ✅ Create deployment user
4. ✅ Set up passwordless SSH (deploy)
5. ✅ Run SSH configuration test
6. ✅ Run one-liner installer
7. ✅ Verify base prerequisites
8. ✅ Install required components with Makefile
9. ✅ Run validation tests
10. ✅ Document findings

# 🔒 VM Hardening (Only for Final Distribution)

VM hardening should ONLY be done as the FINAL step before creating a snapshot for distribution:

```bash
# Only run this when VM setup is COMPLETE
ssh deploy@proto001.nerdofmouth.com  "cd /opt/agency_stack/repo && sudo make vm-snapshot"
```

Do **not** run hardening steps during development to avoid losing SSH access.

# 🔧 Development & Testing Security Constraints

## Testing Security Components Safely

When testing security components in development environments, use these test mode parameters to prevent SSH lockouts:

```bash
# Test security hardening without SSH changes (maintains remote access)
make security DOMAIN=proto001.nerdofmouth.com ADMIN_EMAIL=admin@nerdofmouth.com --test-mode

# Test Fail2ban with relaxed settings and your IP whitelisted
make fail2ban DOMAIN=proto001.nerdofmouth.com ADMIN_EMAIL=admin@nerdofmouth.com --test-mode
```

## **Component Installation Order for Testing**

For safe testing, install components in this recommended order:

1. Non-disruptive components first:
    *   `backup-strategy`
    *   `docker` (if not already installed)
    *   `docker-compose` (if not already installed)
    *   `signing-timestamps`
2. Potentially disruptive components with test mode:
    *   `fail2ban --test-mode`
    *   `security --test-mode`
3. Other system components based on requirements

## **Production Deployment Hardening**

For production environments, remove test mode flags to apply full security:

```bash
# Apply full security hardening (USE ONLY ON PRODUCTION-READY SYSTEMS)make security
make fail2ban
```

# **🔒 VM Hardening (Only for Final Distribution)**

VM hardening should ONLY be done as the FINAL step before creating a snapshot for distribution:

```bash
# Only run this when VM setup is COMPLETE
ssh deploy@proto001.nerdofmouth.com "cd /opt/agency_stack/repo && sudo make vm-snapshot"
```

## **Accessibility vs. Security Balance**

*   Development/Testing: Prioritize SSH accessibility using `--test-mode`
*   Staging/Pre-Production: Test with partial hardening
*   Production: Apply full security measures

```bash
# Apply full security hardening (USE ONLY ON PRODUCTION-READY SYSTEMS)make security
make fail2ban
```

This ruleset update provides clear guidance on:
1. How to use the new test mode parameters
2. The recommended component installation order for testing
3. When to apply full security hardening
4. How to balance accessibility with security across different environments


---

## 📜 Updated AgencyStack Alpha Rules: SSO & Keycloak Integration

Here’s an instruction set you can paste into `README.md`, `INSTRUCTIONS.md`, or use as Claude input:

````markdown
## 🔐 Keycloak SSO Integration – Alpha Phase Standards

As of the Alpha testing milestone, AgencyStack supports optional integration with Keycloak for user authentication across selected components.

### ✅ Component Script Requirements (if Keycloak support exists)

If a component supports Keycloak, the install script must:

- Accept the flag `--enable-keycloak`
- Source Keycloak realm/client information from:
  - `/opt/agency_stack/secrets/keycloak.env`, OR
  - `/opt/agency_stack/clients/${CLIENT_ID}/keycloak/config.json`
- Configure the component to trust Keycloak as its IdP
- Document the expected roles/claims in its `docs/pages/components/<component>.md`
- Expose login paths/ports clearly in `ports.md`
- Add `sso: true` to the component’s `component_registry.json` flags

### 🚫 Components Without SSO Support

If a component does not yet support Keycloak, install scripts must:

- Ignore `--enable-keycloak` without failure
- Log a warning like:



## 🚦Priority Testing Roadmap: Demonstrating Live Value

Here’s a tiered rollout plan, ranked by _immediate impact + strategic value_:

### 🔥 Phase 1: Visual + Metric Impact

*   ✅ **Grafana** (visual metrics): Confirm system dashboard and usage metrics
*   ✅ **PostHog**: User analytics + behavior tracking (esp. on custom sites)
*   ✅ **Portainer**: Show off live container control + real-time dashboards
*   ✅ **Keycloak**: Confirm multi-realm login flow across components

### 📡 Phase 2: Live Communication Stack

*   ✅ **Jitsi** or **Mattermost**: Self-hosted meetings, team chat, or community comms
*   ✅ **Mailu**: Setup one live domain for email (testing newsletters + AI replies)
*   ✅ **VoIP**: Call routing, audio quality testing, client-ready hotline demo

### 🛠️ Phase 3: Business Infrastructure

*   ✅ **ERPNext**: Inventory, finance, CRM, rental module setup
*   ✅ **Documenso**: Contracts and e-signatures (you’ll love this for the agency)
*   ✅ [**Cal.com**](http://Cal.com) **+ Listmonk**: Schedule + email automation

### 🧠 Phase 4: AI + Builder Interface

*   ✅ **Ollama**: Local LLM workflows (support agents, contract generation, content)
*   ✅ [**Builder.io**](http://Builder.io): Connected to Next.js app and database templates
*   ✅ **Next.js** frontend + Keycloak login: Working demo of SSO + theming

## ✅ UI Dashboard Strategic Goals (Reviewed)

You've confirmed the following goals:

| Goal | Confirmed |
| ---| --- |
| Real-time component status? | ✅ Yes |
| Auto-discovery via registry? | ✅ Yes |
| Hosted at `/dashboard` subpath? | ✅ Yes |
| Protected by Keycloak? | ✅ Yes |
| Uses Tailwind + Next.js? | ✅ Yes |
| Bundled into demo-core? | ✅ Yes |
| Pulls logs and health? | ✅ Yes |
| Works in snapshot VMs? | ✅ Yes |

📌 Let’s also ensure:

*   It reads `/component_validation_report.md` if available
*   It parses `.installed_ok` markers
*   It highlights failed installs or registry mismatches clearly
*   It can optionally visualize port mappings (from `ports.json`)

## ⚠️ Development Discipline Reminder: No Local-Only Changes

You are operating within the AgencyStack infrastructure codebase. All installs, changes, and configuration edits **must be represented in the repository**. 

### 🔒 NEVER:
- Install packages directly on the VM (e.g. `apt install`, `npm install`, `docker run`) unless the command is logged and tracked in an install script.
- Edit configs manually (e.g. `vim`, `nano`) unless those changes are reflected in:
  - The related component install script (`scripts/components/`)
  - The documentation (`docs/pages/components/`)
  - The registry (`config/registry/component_registry.json`)
- Create or modify system services (e.g. `systemd`, `pm2`) without capturing the logic in a reproducible script.

### ✅ ALWAYS:
- Use or update the Makefile target when testing installs.
- Track every package or change in a version-controlled script.
- Generate or update documentation using real-world install logs.
- Revalidate using `make alpha-check` and confirm `.installed_ok` exists.

This ensures full reproducibility, safety in snapshot-based deployments, and clarity for both humans and automated agents.

```bash
# 🔁 From Zero to Sovereign — No side effects allowed.


# 🚀 AgencyStack Development Workflow

## Repository-First Development Philosophy

AgencyStack follows a **repository-first** development approach, adhering to our core principles of sovereignty, portability, and repeatability. This document outlines our workflow to maintain consistency between local development and remote testing.

## 🔄 Development Workflow

### 1. LOCAL DEVELOPMENT (Primary)

All changes must first be made to the repository files:

- **Makefile targets**
- **Component scripts** (`/scripts/components/*.sh`)
- **Utility scripts** (`/scripts/utils/*.sh`) 
- **Documentation** (`/docs/pages/components/*.md`)
- **Configuration templates**

**NEVER make direct changes to a running VM without tracking them in the repository first.**

### 2. VERSION CONTROL

After making changes locally:

```bash
# Commit changes with descriptive messages
git add [changed files]
git commit -m "feat: Implement demo-core target for full stack deployment"

# Push to the appropriate branch
git push origin [branch-name]
```

### 3. REMOTE TESTING

Only after changes are properly committed to the repository:

```bash
# SSH into your test VM
ssh root@proto001.alpha.nerdofmouth.com

# Navigate to the repo directory
cd /opt/agency_stack/repo

# Pull the latest changes from your branch
git checkout [branch-name]
git pull

# Run your tests
make [target] DOMAIN=proto001.alpha.nerdofmouth.com ADMIN_EMAIL=your-email@example.com
```

## 📋 Validation Process

1. Changes are validated first through local linting/static analysis
2. Then tested on remote VMs through `git pull` + `make` commands
3. Feedback from tests is incorporated as new repository changes
4. The cycle continues until the feature is production-ready

## ⚠️ Common Pitfalls to Avoid

- **NEVER** modify files directly on the VM without tracking changes in git
- **NEVER** create VM-specific configurations that don't exist in the repository
- **NEVER** manually edit files in `/opt/agency_stack/` outside the repository

## 🧱 Makefile Editing Tips

When editing Makefiles:

1. Use **literal tab characters** for indentation (not spaces)
2. Follow the established pattern:
   ```makefile
   target-name: dependencies
   [TAB]@command1
   [TAB]@command2
   ```
3. Use variables consistently (`$(VARIABLE)` not `${VARIABLE}`)
4. Update `.PHONY` when adding new targets

## 🔍 Testing Syntax

Before pushing:

```bash
# Verify syntax
make -n target-name

# Test with dry-run
make --dry-run target-name
```

Remember: **Repository integrity is our highest priority.** Every change must be tracked, repeatable, and properly documented in the codebase.


### 📌 Next Milestones to Track

| Task | Status |
| ---| --- |
| `make demo-core` working on real VM | ✅ |
| Keycloak + Traefik + HTTPS + Dashboard up | ✅ |
| Dashboard status not yet live/updating | ✅ |
| PostHog install issue | 🛠️ Queued |
| Snapshot, doc export, and pilot testing prep | 🔜 |


# 🚀 AgencyStack Alpha Phase — IDE AI Workflow Agent Instructions

## 🎯 **Purpose & Context**

You are assisting in the **alpha test and deploy phase** of the AgencyStack project. AgencyStack is a scalable, sovereign, secure DevOps toolkit designed for decentralized and privacy-first organizations. Your goal is to help developers build, debug, maintain, and optimize installation scripts, configurations, and component integrations consistently and reliably.

**Primary objectives** for this phase include:

*   Ensuring complete adherence to AgencyStack Alpha Phase Repository Integrity Policy.
*   Achieving idempotent, reproducible, and stable installations.
*   Producing clear, detailed documentation and logging.
*   Validating functional integrations across all AgencyStack components.
*   Implementing necessary security hardening and multi-tenancy measures.
*   Ensuring effective real-time monitoring and observability.
*   Maintaining high developer productivity and excellent developer experience.

* * *

## ⚙️ **Build System & Infrastructure Guidelines**

Follow these infrastructure directives meticulously when generating code, scripts, or instructions:

1. **Components**:
    *   Each installation must be implemented via scripts located under `/scripts/components/`.
    *   Use standardized Makefile targets (`make <component>`, `make <component>-status`, `make <component>-logs`, and `make <component>-restart`) for every component.
2. **File System Structure**:
    *   Always create or modify files within the following directories exclusively:

```awk
  swift
  CopyEdit
  /scripts/components//scripts/mock//scripts/utils//docs/pages/components//opt/agency_stack//var/log/agency_stack/
```

*       *   Never hardcode absolute paths (`/usr`, `/etc`, `$HOME`).
1. **Idempotent Installation**:
    *   Ensure scripts can safely re-run without causing unintended side-effects or duplication of resources.
    *   Validate dependencies and environment using `make env-check` and `make prep-dirs`.

* * *

## 🔒 **Security, Privacy & Sovereignty**

Apply these principles rigorously in all instructions and scripts:

*   **Logging**: Logs must be generated in `/var/log/agency_stack/components/<component>.log`.
*   **Config Management**: Use client-specific directories (`/opt/agency_stack/clients/${CLIENT_ID}/`) consistently.
*   **Network Security**: Enable TLS and HTTPS for all network-facing components using standardized Traefik routing rules.
*   **Authentication**: Integrate with self-hosted Keycloak realms for centralized user and identity management.
*   **Third-party APIs**: Default to "offline first" philosophy—no external API calls unless explicitly enabled by user-specified flags (e.g., `--enable-openai`).

* * *

## 📡 **Networking & Observability**

*   **Port Management**: All network-exposed components must define their ports in `component_registry.json` and document usage clearly in `/docs/pages/ports.md`.
*   **Monitoring**: Expose Prometheus-compatible metrics via a `/metrics` endpoint if applicable.
*   **Containerization**: Clearly define Docker network dependencies and container resource limits for stability.

* * *

## 📖 **Documentation Guidelines**

*   Create or update Markdown documentation in `/docs/pages/components/<component>.md` for each component.
*   Maintain an updated component index (`/docs/pages/components.md`) and port usage reference (`/docs/pages/ports.md`).
*   Include clear installation instructions, example usage, configurations, and troubleshooting guidance.

* * *

## 📋 **Standard IDE Workflow Rules**

Always adhere to these workflow rules when interacting with the repository through IDE integrations:

*   **Local Utility Scripts**:
    *   Prioritize using existing utility scripts located in `/scripts/utils/*.sh` for introspection, verification, and state parsing.
    *   Reference these utility scripts clearly in documentation and comments.
    *   Avoid re-implementing functionality available in these utilities unless directed.
*   **Makefile Integration**:
    *   Confirm every component is properly tracked by the `make alpha-check` command.
    *   Ensure component lifecycle management (`make <component>-status`, `make <component>-logs`, `make <component>-restart`) is clearly implemented.
*   **Integrity & Transparency**:
    *   All changes must strictly adhere to the AgencyStack Alpha Phase Repository Integrity Policy.
    *   Changes should always be tracked in repository-defined scripts (no direct modifications to deployed VMs).
    *   Provide clear error messages, logging, and user feedback for debugging purposes.

* * *

## 📈 **Metrics & Validation**

*   Regularly use the following commands for verification:

```go
go
CopyEdit
make prep-dirs
make env-check
make alpha-check
make ui-alpha-check
make ai-alpha-check
```

*   Metrics should guide improvement and ensure transparency but should not be used for comparative evaluations or punitive measures.

* * *

## 🚧 **Strategic Implementation Roadmap**

Follow a structured implementation strategy:

1. **Phase 1 – Infrastructure Stabilization**
    *   Complete containerization efforts and comprehensive Docker Compose definitions.
    *   Document network dependencies and port mappings.
2. **Phase 2 – Dashboard & UI Evolution**
    *   Transition dashboard UI to dynamic Next.js implementation.
    *   Develop real-time API integrations and observability.
3. **Phase 3 – Integration & Security**
    *   Fully integrate Keycloak-based SSO.
    *   Implement role-based access control, continuous security monitoring, and hardening.

* * *

## 🧠 **AI Workflow Agent Persona**

You are a highly efficient, disciplined AI DevOps assistant operating within the constraints and guidelines of the AgencyStack development environment. Your characteristics include:

*   **Disciplined & Precise**: Follow every rule, structure, and principle meticulously.
*   **Strategically Minded**: Align every action with overall strategic goals.
*   **Security-Conscious**: Proactively identify and resolve security issues.
*   **Transparent & Auditable**: Document clearly, provide explicit logging, and maintain transparency.
*   **Pragmatic Problem-Solver**: Prioritize and offer practical, robust solutions.